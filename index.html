<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Event Finder | Home</title>
    <meta
      name="description"
      content="Discover concerts, festivals, shows, and more near you."
    />
    <link rel="stylesheet" href="index.css" />
    <style>
      /* Genre filter chips */
      .genre-filters {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        margin: 20px 0;
        justify-content: center;
      }

      .genre-chip {
        padding: 10px 20px;
        border: 2px solid #e0e0e0;
        border-radius: 25px;
        background: white;
        cursor: pointer;
        transition: all 0.3s;
        font-weight: 500;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .genre-chip:hover {
        border-color: #667eea;
        background: #f0f3ff;
        transform: translateY(-2px);
      }

      .genre-chip.active {
        border-color: #667eea;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
      }

      /* Event cards enhancement */
      .event-card {
        position: relative;
      }

      .event-image {
        width: 100%;
        height: 200px;
        object-fit: cover;
        border-radius: 12px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      }

      .event-price {
        position: absolute;
        top: 10px;
        right: 10px;
        background: rgba(255, 255, 255, 0.95);
        padding: 8px 15px;
        border-radius: 20px;
        font-weight: bold;
        color: #333;
      }

      .event-genres {
        display: flex;
        gap: 5px;
        flex-wrap: wrap;
        margin: 10px 0;
      }

      .event-genre-tag {
        background: #f0f0f0;
        padding: 4px 10px;
        border-radius: 12px;
        font-size: 0.75rem;
        display: flex;
        align-items: center;
        gap: 5px;
      }

      .favorite-btn {
        transition: all 0.3s;
      }

      .favorite-btn.favorited {
        background: #ff6b6b;
        color: white;
      }

      .favorite-btn.favorited:hover {
        background: #ff5252;
      }

      .loading-spinner {
        text-align: center;
        padding: 60px;
        color: #999;
        font-size: 1.2rem;
      }

      .no-events {
        text-align: center;
        padding: 60px 20px;
        color: #999;
      }

      .event-distance {
        color: #667eea;
        font-weight: 600;
        font-size: 0.9rem;
      }

      /* User menu */
      .user-menu {
        position: relative;
      }

      .user-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        cursor: pointer;
      }

      .admin-badge {
        position: absolute;
        top: -5px;
        right: -5px;
        background: #ff6b6b;
        color: white;
        font-size: 0.6rem;
        padding: 2px 6px;
        border-radius: 10px;
        font-weight: bold;
      }
    </style>
  </head>

  <body>
    <a class="skip-link" href="#main-content">Skip to content</a>

    <!-- HEADER / NAV -->
    <header class="tm-navbar">
      <div class="tm-nav-content">
        <!-- LOGO -->
        <div class="tm-logo">
          <a href="index. html">EventFinder</a>
        </div>

        <!-- NAV LINKS -->
        <nav class="tm-links">
          <a href="index.html" class="active">Home</a>
          <a href="favorites.html" id="favorites-link" style="display: none"
            >Favorites</a
          >
          <a href="account.html" id="profile-link" style="display: none"
            >Account</a
          >
          <a href="admin.html" id="admin-link" style="display: none">Admin</a>
        </nav>

        <!-- SEARCH -->
        <div class="tm-search">
          <input
            type="text"
            id="header-search"
            placeholder="Search events..."
          />
          <button id="header-search-btn"><span>Search</span></button>
        </div>

        <!-- AUTH -->
        <div class="tm-auth">
          <a href="login.html" class="tm-login-btn" id="login-btn">Login</a>
          <div class="user-menu" id="user-menu" style="display: none">
            <div class="user-avatar" id="user-avatar">U</div>
            <div class="admin-badge" id="admin-badge" style="display: none">
              ADMIN
            </div>
          </div>
        </div>
      </div>
    </header>

    <!-- MAIN -->
    <main id="main-content">
      <!-- HERO -->
      <section id="hero">
        <h2>Find Events Near You</h2>
        <p>Concerts ‚Ä¢ Sports ‚Ä¢ Festivals ‚Ä¢ Workshops ‚Ä¢ And More</p>

        <div class="search-bar">
          <input type="text" id="search-input" placeholder="Search events..." />
          <button id="search-btn">Search</button>
        </div>
      </section>

      <!-- GENRE FILTERS -->
      <section id="genre-section">
        <div class="genre-filters" id="genre-filters">
          <div class="genre-chip active" data-genre="">
            <span>üéâ</span>
            <span>All Events</span>
          </div>
          <!-- Genres loaded dynamically -->
        </div>
      </section>

      <!-- FILTERS -->
      <section id="filters">
        <button id="filter-toggle" type="button" aria-expanded="false">
          Advanced Filters ‚ñæ
        </button>

        <div id="filter-panel" class="collapsed">
          <form id="filter-form">
            <div class="filter-group">
              <label for="filter-date">Date</label>
              <input type="date" id="filter-date" />
            </div>

            <div class="filter-group">
              <label for="filter-location">Location</label>
              <input
                type="text"
                id="filter-location"
                placeholder="City or venue"
              />
            </div>

            <div class="filter-group">
              <label for="filter-radius">Radius (km)</label>
              <input
                type="number"
                id="filter-radius"
                placeholder="10"
                min="1"
                max="100"
              />
            </div>

            <button type="submit" id="apply-filters-btn">Apply Filters</button>
            <button type="button" id="clear-filters-btn">Clear Filters</button>
          </form>
        </div>
      </section>

      <!-- EVENTS -->
      <section id="events-section">
        <h3 id="events-heading">All Events</h3>

        <div id="events-container" class="loading-spinner">
          <p>‚è≥ Loading events...</p>
        </div>
      </section>
    </main>

    <!-- FOOTER -->
    <footer>
      <p>¬© 2025 Event Finder</p>
      <p class="disclaimer">Discover amazing events near you.</p>
    </footer>

    <!-- Firebase -->
    <!-- Firebase ES6 Module -->
    <script type="module">
      import { auth } from "/web-proj/firebase-config.js";
      import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

      let allEvents = [];
      let allGenres = [];
      let userFavorites = [];
      let currentUser = null;
      let selectedGenre = "";
      let userLocation = null;

      // Initialize
      window.addEventListener("DOMContentLoaded", async () => {
        // Check authentication
        onAuthStateChanged(auth, async (firebaseUser) => {
          if (firebaseUser) {
            await loadCurrentUser(firebaseUser);
            updateUIForLoggedIn();
            await loadFavorites();
          } else {
            updateUIForLoggedOut();
          }
        });

        // Load genres and events
        await loadGenres();
        await loadEvents();

        // Try to get user location
        getUserLocation();

        // Setup event listeners
        setupEventListeners();
      });

      // Load current user
      async function loadCurrentUser(firebaseUser) {
        try {
          const response = await fetch("/web-proj/api/me.php", {
            headers: { "X-Firebase-UID": firebaseUser.uid },
          });
          const data = await response.json();
          if (data.user) {
            currentUser = data.user;
          }
        } catch (error) {
          console.error("Failed to load user:", error);
        }
      }

      // Update UI for logged in user
      function updateUIForLoggedIn() {
        document.getElementById("login-btn").style.display = "none";
        document.getElementById("user-menu").style.display = "block";
        document.getElementById("favorites-link").style.display = "block";
        document.getElementById("profile-link").style.display = "block";

        if (currentUser) {
          const avatar = document.getElementById("user-avatar");
          avatar.textContent = currentUser.name.charAt(0).toUpperCase();

          // Show admin link if admin or owner
          if (["admin", "owner"].includes(currentUser.role)) {
            document.getElementById("admin-link").style.display = "block";
            document.getElementById("admin-badge").style.display = "block";
          }
        }
      }

      // Update UI for logged out user
      function updateUIForLoggedOut() {
        document.getElementById("login-btn").style.display = "block";
        document.getElementById("user-menu").style.display = "none";
        document.getElementById("favorites-link").style.display = "none";
        document.getElementById("profile-link").style.display = "none";
        document.getElementById("admin-link").style.display = "none";
      }

      // Load genres
      async function loadGenres() {
        try {
          const response = await fetch("api/genres.php");
          const data = await response.json();
          if (data.success) {
            allGenres = data.genres;
            renderGenreFilters();
          }
        } catch (error) {
          console.error("Failed to load genres:", error);
        }
      }

      // Render genre filter chips
      function renderGenreFilters() {
        const container = document.getElementById("genre-filters");

        allGenres.forEach((genre) => {
          const chip = document.createElement("div");
          chip.className = "genre-chip";
          chip.dataset.genre = genre.slug;
          chip.innerHTML = `
    <span>${genre.name}</span>
`;

          chip.addEventListener("click", () => {
            selectGenre(genre.slug);
          });

          container.appendChild(chip);
        });
      }

      // Select genre filter
      function selectGenre(genreSlug) {
        selectedGenre = genreSlug;

        // Update UI
        document.querySelectorAll(". genre-chip").forEach((chip) => {
          chip.classList.remove("active");
          if (chip.dataset.genre === genreSlug) {
            chip.classList.add("active");
          }
        });

        // Update heading
        if (genreSlug) {
          const genre = allGenres.find((g) => g.slug === genreSlug);
          document.getElementById(
            "events-heading"
          ).textContent = `${genre.icon} ${genre.name} Events`;
        } else {
          document.getElementById("events-heading").textContent = "All Events";
        }

        // Reload events
        loadEvents();
      }

      // Load events
      async function loadEvents() {
        const container = document.getElementById("events-container");
        container.innerHTML =
          '<p class="loading-spinner">‚è≥ Loading events...</p>';

        try {
          // Load all events first (unfiltered)
          const baseUrl = "/web-proj/api/events.php";
          const resAll = await fetch(baseUrl);
          const dataAll = await resAll.json();

          if (dataAll && dataAll.success && Array.isArray(dataAll.events)) {
            allEvents = dataAll.events;
            document.getElementById("events-heading").textContent =
              "All Events";
            renderEvents();
          } else {
            throw new Error("Failed to load all events");
          }

          // Build geolocated URL (no leading space; only append params that exist)
          let url = baseUrl;
          const qs = new URLSearchParams();

          if (selectedGenre) {
            qs.append("genre", selectedGenre);
          }
          if (
            userLocation &&
            typeof userLocation.lat === "number" &&
            typeof userLocation.lng === "number"
          ) {
            qs.append("lat", String(userLocation.lat));
            qs.append("lng", String(userLocation.lng));
            qs.append("radius", "50"); // default radius here (client-side)
          }

          if ([...qs].length > 0) {
            url = `${baseUrl}?${qs.toString()}`;
          }

          // Try geolocated fetch; only replace list if results exist
          const resGeo = await fetch(url);
          const dataGeo = await resGeo.json();

          if (dataGeo && dataGeo.success && Array.isArray(dataGeo.events)) {
            if (dataGeo.events.length > 0) {
              allEvents = dataGeo.events;
              document.getElementById("events-heading").textContent =
                "Nearby Events";
              renderEvents();
            } else {
              // Keep the "All Events" render; optionally show info
              const info = document.createElement("p");
              info.className = "no-events";
              info.textContent = "No nearby events found. Showing all events.";
              container.prepend(info);
            }
          }
        } catch (error) {
          console.error("Failed to load events:", error);
          container.innerHTML =
            '<div class="no-events"><h3>Failed to load events</h3><p>Please try again later.</p></div>';
        }
      }

      // Render events
      function renderEvents() {
        const container = document.getElementById("events-container");

        if (allEvents.length === 0) {
          container.innerHTML =
            '<div class="no-events"><h3>No events found</h3><p>Try different filters or check back later! </p></div>';
          return;
        }

        container.innerHTML = "";

        allEvents.forEach((event) => {
          const card = document.createElement("div");
          card.className = "event-card";

          const isFavorited = userFavorites.includes(event.id);
          const imageUrl =
            event.image_url ||
            "https://placehold.co/400x200/667eea/white?text=Event";
          const price =
            event.price > 0 ? `$${parseFloat(event.price).toFixed(2)}` : "FREE";
          const distance = event.distance_km
            ? `üìç ${event.distance_km} km away`
            : "";

          card.innerHTML = `
                    <div class="event-preview">
                        <img src="${imageUrl}" alt="${
            event.title
          }" class="event-image" onerror="this.src='https://placehold.co/400x200/667eea/white?text=Event'">
                        <span class="event-price">${price}</span>
                    </div>

                    <h4>${event.title}</h4>
                    <p class="event-info">üìç ${event.location} ‚Ä¢ üìÖ ${
            event.date
          } ${event.time ? "‚Ä¢ üïê " + event.time : ""}</p>
                    ${
                      distance
                        ? `<p class="event-distance">${distance}</p>`
                        : ""
                    }
                    
                    <div class="event-genres">
                        ${(event.genre_icons || [])
                          .map(
                            (icon, i) => `
                            <span class="event-genre-tag">
                                <span>${icon}</span>
                                <span>${event.genres[i]}</span>
                            </span>
                        `
                          )
                          .join("")}
                    </div>

                    <div class="card-actions">
                        <button class="details-btn" onclick="window.viewEventDetails(${
                          event.id
                        })">View Details</button>
                        <button class="favorite-btn ${
                          isFavorited ? "favorited" : ""
                        }" onclick="window.toggleFavorite(${event.id})" ${
            currentUser ? "" : "disabled"
          }>
                            ${
                              isFavorited
                                ? "‚ù§Ô∏è Favorited"
                                : "‚ô° Add to Favorites"
                            }
                        </button>
                    </div>
                `;

          container.appendChild(card);
        });
      }

      // Load user favorites
      async function loadFavorites() {
        if (!currentUser) return;

        try {
          const firebaseUser = auth.currentUser;
          const response = await fetch("/web-proj/api/favorites.php", {
            headers: { "X-Firebase-UID": firebaseUser.uid },
          });
          const data = await response.json();

          if (data.success) {
            userFavorites = data.favorites.map((f) => f.id);
          }
        } catch (error) {
          console.error("Failed to load favorites:", error);
        }
      }

      // Toggle favorite - Export to window so onclick can access it
      window.toggleFavorite = async function (eventId) {
        if (!currentUser) {
          alert("Please log in to add favorites");
          return;
        }

        const firebaseUser = auth.currentUser;
        const isFavorited = userFavorites.includes(eventId);

        try {
          const response = await fetch(
            "/web-proj/api/favorites.php" +
              (isFavorited ? `?event_id=${eventId}` : ""),
            {
              method: isFavorited ? "DELETE" : "POST",
              headers: {
                "Content-Type": "application/json",
                "X-Firebase-UID": firebaseUser.uid,
              },
              body: isFavorited ? null : JSON.stringify({ event_id: eventId }),
            }
          );

          const data = await response.json();

          if (data.success) {
            if (isFavorited) {
              userFavorites = userFavorites.filter((id) => id !== eventId);
            } else {
              userFavorites.push(eventId);
            }
            renderEvents();
          }
        } catch (error) {
          console.error("Failed to toggle favorite:", error);
          alert("Failed to update favorite");
        }
      };

      // View event details - Export to window
      window.viewEventDetails = function (eventId) {
        window.location.href = `/web-proj/event.html?id=${eventId}`;
      };

      // Get user location
      function getUserLocation() {
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(
            (position) => {
              userLocation = {
                lat: position.coords.latitude,
                lng: position.coords.longitude,
              };
              loadEvents();
            },
            (error) => {
              console.log("Location access denied:", error);
            }
          );
        }
      }

      // Setup event listeners
      function setupEventListeners() {
        const toggleBtn = document.getElementById("filter-toggle");
        const panel = document.getElementById("filter-panel");

        toggleBtn.addEventListener("click", () => {
          const open = panel.classList.contains("expanded");

          if (open) {
            panel.classList.remove("expanded");
            panel.classList.add("collapsed");
            toggleBtn.innerText = "Advanced Filters ‚ñæ";
            toggleBtn.setAttribute("aria-expanded", "false");
          } else {
            panel.classList.remove("collapsed");
            panel.classList.add("expanded");
            toggleBtn.innerText = "Advanced Filters ‚ñ¥";
            toggleBtn.setAttribute("aria-expanded", "true");
          }
        });

        // Search
        document
          .getElementById("search-btn")
          .addEventListener("click", searchEvents);
        document
          .getElementById("header-search-btn")
          .addEventListener("click", searchEvents);
        document
          .getElementById("search-input")
          .addEventListener("keypress", (e) => {
            if (e.key === "Enter") searchEvents();
          });
        document
          .getElementById("header-search")
          .addEventListener("keypress", (e) => {
            if (e.key === "Enter") searchEvents();
          });

        // Clear filters
        document
          .getElementById("clear-filters-btn")
          .addEventListener("click", () => {
            document.getElementById("filter-form").reset();
            selectedGenre = "";
            document.querySelectorAll(".genre-chip").forEach((chip) => {
              chip.classList.remove("active");
              if (chip.dataset.genre === "") chip.classList.add("active");
            });
            loadEvents();
          });
      }

      // Search events
      function searchEvents() {
        const query =
          document.getElementById("search-input").value ||
          document.getElementById("header-search").value;
        if (!query) return;

        const filtered = allEvents.filter(
          (event) =>
            event.title.toLowerCase().includes(query.toLowerCase()) ||
            event.description?.toLowerCase().includes(query.toLowerCase()) ||
            event.location?.toLowerCase().includes(query.toLowerCase())
        );

        allEvents = filtered;
        renderEvents();
      }
    </script>
  </body>
</html>
