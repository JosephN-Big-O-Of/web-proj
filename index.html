<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Event Finder | Home</title>
    <meta
      name="description"
      content="Discover concerts, festivals, shows, and more near you."
    />
    <link rel="stylesheet" href="index.css" />
    <style>
      /* Genre filter chips */
      .genre-filters {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        margin: 20px 0;
        justify-content: center;
      }

      .genre-chip {
        padding: 10px 20px;
        border: 2px solid #e0e0e0;
        border-radius: 25px;
        background: white;
        cursor: pointer;
        transition: all 0.3s;
        font-weight: 500;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .genre-chip:hover {
        border-color: #667eea;
        background: #f0f3ff;
        transform: translateY(-2px);
      }

      .genre-chip.active {
        border-color: #667eea;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
      }

      /* Event cards enhancement */
      .event-card {
        position: relative;
      }

      .event-image {
        width: 100%;
        height: 200px;
        object-fit: cover;
        border-radius: 12px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      }

      .event-price {
        position: absolute;
        top: 10px;
        right: 10px;
        background: rgba(255, 255, 255, 0.95);
        padding: 8px 15px;
        border-radius: 20px;
        font-weight: bold;
        color: #333;
      }

      .event-genres {
        display: flex;
        gap: 5px;
        flex-wrap: wrap;
        margin: 10px 0;
      }

      .event-genre-tag {
        background: #f0f0f0;
        padding: 4px 10px;
        border-radius: 12px;
        font-size: 0.75rem;
        display: flex;
        align-items: center;
        gap: 5px;
      }

      .favorite-btn {
        transition: all 0.3s;
      }

      .favorite-btn.favorited {
        background: #ff6b6b;
        color: white;
      }

      .favorite-btn.favorited:hover {
        background: #ff5252;
      }

      .loading-spinner {
        text-align: center;
        padding: 60px;
        color: #999;
        font-size: 1.2rem;
      }

      .no-events {
        text-align: center;
        padding: 60px 20px;
        color: #999;
      }

      .event-distance {
        color: #667eea;
        font-weight: 600;
        font-size: 0.9rem;
      }

      /* User menu */
      .user-menu {
        position: relative;
      }

      .user-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        cursor: pointer;
      }

      .admin-badge {
        position: absolute;
        top: -5px;
        right: -5px;
        background: #ff6b6b;
        color: white;
        font-size: 0.6rem;
        padding: 2px 6px;
        border-radius: 10px;
        font-weight: bold;
      }
    </style>
  </head>

  <body>
    <a class="skip-link" href="#main-content">Skip to content</a>

    <!-- HEADER / NAV -->
    <header class="tm-navbar">
      <div class="tm-nav-content">
        <!-- LOGO -->
        <div class="tm-logo">
          <a href="index. html">EventFinder</a>
        </div>

        <!-- NAV LINKS -->
        <nav class="tm-links">
          <a href="index.html" class="active">Home</a>
          <a href="favorites.html" id="favorites-link" style="display: none"
            >Favorites</a
          >
          <a href="account.html" id="profile-link" style="display: none"
            >Account</a
          >
          <a href="admin.html" id="admin-link" style="display: none">Admin</a>
        </nav>

        <!-- SEARCH -->
        <div class="tm-search">
          <input
            type="text"
            id="header-search"
            placeholder="Search events..."
          />
          <button id="header-search-btn"><span>Search</span></button>
        </div>

        <!-- AUTH -->
        <div class="tm-auth">
          <a href="login.html" class="tm-login-btn" id="login-btn">Login</a>
          <div class="user-menu" id="user-menu" style="display: none">
            <div class="user-avatar" id="user-avatar">U</div>
            <div class="admin-badge" id="admin-badge" style="display: none">
              ADMIN
            </div>
          </div>
        </div>
      </div>
    </header>

    <!-- MAIN -->
    <main id="main-content">
      <!-- HERO -->
      <section id="hero">
        <h2>Find Events Near You</h2>
        <p>Concerts ‚Ä¢ Sports ‚Ä¢ Festivals ‚Ä¢ Workshops ‚Ä¢ And More</p>

        <div class="search-bar">
          <input type="text" id="search-input" placeholder="Search events..." />
          <button id="search-btn">Search</button>
        </div>
      </section>

      <!-- GENRE FILTERS -->
      <section id="genre-section">
        <div class="genre-filters" id="genre-filters">
          <div class="genre-chip active" data-genre="">
            <span>üéâ</span>
            <span>All Events</span>
          </div>
          <!-- Genres loaded dynamically -->
        </div>
      </section>

      <!-- FILTERS -->
      <section id="filters">
        <button id="filter-toggle" type="button" aria-expanded="false">
          Advanced Filters ‚ñæ
        </button>

        <div id="filter-panel" class="collapsed">
          <form id="filter-form">
            <div class="filter-group">
              <label for="filter-date">Date</label>
              <input type="date" id="filter-date" />
            </div>

            <div class="filter-group">
              <label for="filter-location">Location</label>
              <input
                type="text"
                id="filter-location"
                placeholder="City or venue"
              />
            </div>

            <div class="filter-group">
              <label for="filter-radius">Radius (km)</label>
              <input
                type="number"
                id="filter-radius"
                placeholder="10"
                min="1"
                max="100"
              />
            </div>

            <button type="submit" id="apply-filters-btn">Apply Filters</button>
            <button type="button" id="clear-filters-btn">Clear Filters</button>
          </form>
        </div>
      </section>

      <!-- EVENTS -->
      <section id="events-section">
        <h3 id="events-heading">All Events</h3>

        <div id="events-container" class="loading-spinner">
          <p>‚è≥ Loading events...</p>
        </div>
      </section>
    </main>

    <!-- FOOTER -->
    <footer>
      <p>¬© 2025 Event Finder</p>
      <p class="disclaimer">Discover amazing events near you.</p>
    </footer>

    <!-- Firebase -->
    <!-- Firebase ES6 Module -->
    <!-- REPLACE the existing <script type="module"> ... </script> in index.html with the script below -->
    <script type="module">
      import { auth } from "/web-proj/firebase-config.js";
      import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

      let allEvents = [];
      let allGenres = [];
      let userFavorites = [];
      let currentUser = null;
      let selectedGenre = "";
      let userLocation = null;

      window.addEventListener("DOMContentLoaded", async () => {
        onAuthStateChanged(auth, async (firebaseUser) => {
          if (firebaseUser) {
            await loadCurrentUser(firebaseUser);
            updateUIForLoggedIn();
            await loadFavorites();
          } else {
            updateUIForLoggedOut();
          }
        });

        await loadGenres();
        await loadEvents();
        getUserLocation();
        setupEventListeners();
      });

      async function loadCurrentUser(firebaseUser) {
        try {
          const response = await fetch("/web-proj/api/me.php", {
            headers: { "X-Firebase-UID": firebaseUser.uid },
          });
          const data = await response.json();
          if (data.user) currentUser = data.user;
        } catch (error) {
          console.error("Failed to load user:", error);
        }
      }

      function updateUIForLoggedIn() {
        document.getElementById("login-btn").style.display = "none";
        document.getElementById("user-menu").style.display = "block";
        document.getElementById("favorites-link").style.display = "block";
        document.getElementById("profile-link").style.display = "block";
        if (currentUser) {
          const avatar = document.getElementById("user-avatar");
          avatar.textContent = currentUser.name
            ? currentUser.name.charAt(0).toUpperCase()
            : "U";
          if (["admin", "owner"].includes(currentUser.role)) {
            document.getElementById("admin-link").style.display = "block";
            document.getElementById("admin-badge").style.display = "block";
          }
        }
      }

      function updateUIForLoggedOut() {
        document.getElementById("login-btn").style.display = "block";
        document.getElementById("user-menu").style.display = "none";
        document.getElementById("favorites-link").style.display = "none";
        document.getElementById("profile-link").style.display = "none";
        document.getElementById("admin-link").style.display = "none";
      }

      // Load genres from API
      async function loadGenres() {
        try {
          const response = await fetch("api/genres.php");
          const data = await response.json();
          if (data.success) {
            allGenres = data.genres;
            renderGenreFilters();
          }
        } catch (error) {
          console.error("Failed to load genres:", error);
        }
      }

      // Render genre chips (text-only, no emojis)
      function renderGenreFilters() {
        const container = document.getElementById("genre-filters");
        container.innerHTML = "";

        // "All Events" chip (text-only)
        const allChip = document.createElement("div");
        allChip.className = "genre-chip active";
        allChip.dataset.genre = "";
        allChip.textContent = "All Events";
        allChip.addEventListener("click", () => {
          selectGenre("");
        });
        container.appendChild(allChip);

        allGenres.forEach((genre) => {
          const chip = document.createElement("div");
          chip.className = "genre-chip";
          chip.dataset.genre = genre.slug || genre.name;
          // text-only rendering
          const labelSpan = document.createElement("span");
          labelSpan.textContent = genre.name;
          chip.appendChild(labelSpan);

          chip.addEventListener("click", () => {
            selectGenre(genre.slug || genre.name);
          });
          container.appendChild(chip);
        });
      }

      // Select genre, update UI, reload events
      function selectGenre(genreSlug) {
        selectedGenre = genreSlug || "";

        document.querySelectorAll(".genre-chip").forEach((chip) => {
          chip.classList.toggle("active", chip.dataset.genre === selectedGenre);
        });

        const heading = document.getElementById("events-heading");
        if (selectedGenre) {
          const genre = allGenres.find(
            (g) => g.slug === selectedGenre || g.name === selectedGenre
          );
          heading.textContent = `${genre ? genre.name : selectedGenre} Events`;
        } else {
          heading.textContent = "All Events";
        }

        loadEvents();
      }

      // Create event card element (no emoji/icon output)
      function createEventCard(event) {
        const card = document.createElement("div");
        card.className = "event-card";

        const title = event.name || event.title || "Untitled Event";
        const location = event.location || "Location TBA";
        const date = event.date || "TBA";
        const time = event.time ? `‚Ä¢ üïê ${event.time}` : "";
        const price =
          event.price && parseFloat(event.price) > 0
            ? `$${parseFloat(event.price).toFixed(2)}`
            : "FREE";
        const isFavorited = userFavorites.includes(Number(event.id));
        const imageUrl =
          event.image_url ||
          "https://placehold.co/400x200/667eea/white?text=Event";

        // build DOM safely (no innerHTML with emojis)
        const preview = document.createElement("div");
        preview.className = "event-preview";
        const img = document.createElement("img");
        img.className = "event-image";
        img.src = imageUrl;
        img.alt = title;
        img.onerror = function () {
          this.src = "https://placehold.co/400x200/667eea/white?text=Event";
        };
        const priceSpan = document.createElement("span");
        priceSpan.className = "event-price";
        priceSpan.textContent = price;
        preview.appendChild(img);
        preview.appendChild(priceSpan);

        const h4 = document.createElement("h4");
        h4.textContent = title;

        const infoP = document.createElement("p");
        infoP.className = "event-info";
        infoP.textContent = `${location} ‚Ä¢ ${date} ${time}`;

        const genresDiv = document.createElement("div");
        genresDiv.className = "event-genres";
        if (event.genre_name) {
          const tag = document.createElement("span");
          tag.className = "event-genre-tag";
          tag.textContent = event.genre_name;
          genresDiv.appendChild(tag);
        }

        const distance = event.distance_km
          ? `<p class="event-distance">üìç ${event.distance_km} km away</p>`
          : "";

        const actionsDiv = document.createElement("div");
        actionsDiv.className = "card-actions";
        const detailsBtn = document.createElement("button");
        detailsBtn.className = "details-btn";
        detailsBtn.dataset.id = event.id;
        detailsBtn.textContent = "View Details";
        detailsBtn.addEventListener("click", () =>
          window.viewEventDetails(event.id)
        );

        const favBtn = document.createElement("button");
        favBtn.className = "favorite-btn";
        if (isFavorited) favBtn.classList.add("favorited");
        favBtn.dataset.id = event.id;
        favBtn.disabled = !currentUser;
        favBtn.textContent = isFavorited
          ? "‚ù§Ô∏è Favorited"
          : "‚ô° Add to Favorites";
        favBtn.addEventListener("click", () => window.toggleFavorite(event.id));

        actionsDiv.appendChild(detailsBtn);
        actionsDiv.appendChild(favBtn);

        // append children
        card.appendChild(preview);
        card.appendChild(h4);
        card.appendChild(infoP);
        if (distance) {
          const ddiv = document.createElement("div");
          ddiv.innerHTML = distance; // ok for this small string
          card.appendChild(ddiv);
        }
        card.appendChild(genresDiv);
        card.appendChild(actionsDiv);

        return card;
      }

      // Render allEvents into DOM
      function renderEvents() {
        const container = document.getElementById("events-container");
        container.innerHTML = "";

        if (!allEvents || allEvents.length === 0) {
          container.innerHTML =
            '<div class="no-events"><h3>No events found</h3><p>Try different filters or check back later!</p></div>';
          return;
        }

        allEvents.forEach((event) => {
          const card = createEventCard(event);
          container.appendChild(card);
        });
      }

      // Load events from API (no emoji/icon usage)
      async function loadEvents() {
        const container = document.getElementById("events-container");
        container.innerHTML =
          '<p class="loading-spinner">‚è≥ Loading events...</p>';

        try {
          const params = new URLSearchParams();
          if (selectedGenre) params.append("genre", selectedGenre);
          if (userLocation) {
            params.append("lat", userLocation.lat);
            params.append("lng", userLocation.lng);
            params.append("radius", 50);
          }

          const response = await fetch(
            `/web-proj/api/events.php?${params.toString()}`
          );
          const data = await response.json();
          console.log("Events API response:", data);

          if (data.success) {
            allEvents = data.events.map((e) => {
              e.id = Number(e.id);
              return e;
            });
            renderEvents();
          } else {
            container.innerHTML =
              '<div class="no-events"><h3>No events available</h3></div>';
          }
        } catch (error) {
          console.error("Failed to load events:", error);
          container.innerHTML =
            '<div class="no-events"><h3>Failed to load events</h3><p>Please try again later.</p></div>';
        }
      }

      // Load user favorites
      async function loadFavorites() {
        if (!currentUser) return;
        try {
          const firebaseUser = auth.currentUser;
          const response = await fetch("/web-proj/api/favorites.php", {
            headers: { "X-Firebase-UID": firebaseUser.uid },
          });
          const data = await response.json();
          if (data.success)
            userFavorites = data.favorites.map((f) => Number(f.id));
        } catch (error) {
          console.error("Failed to load favorites:", error);
        }
      }

      // Toggle favorite (optimistic + logging)
      window.toggleFavorite = async function (eventId) {
        if (!currentUser) {
          alert("Please log in to add favorites");
          return;
        }
        const fid = Number(eventId);
        const isFavorited = userFavorites.includes(fid);

        // optimistic update
        if (!isFavorited) userFavorites.push(fid);
        else userFavorites = userFavorites.filter((id) => id !== fid);
        renderEvents();

        try {
          const firebaseUser = auth.currentUser;
          const resp = await fetch(
            "/web-proj/api/favorites.php" +
              (isFavorited ? `?event_id=${fid}` : ""),
            {
              method: isFavorited ? "DELETE" : "POST",
              headers: {
                "Content-Type": "application/json",
                "X-Firebase-UID": firebaseUser.uid,
              },
              body: isFavorited ? null : JSON.stringify({ event_id: fid }),
            }
          );
          const data = await resp.json();
          console.log("toggleFavorite response", resp.status, data);
          if (!resp.ok || !data.success) {
            // revert
            if (!isFavorited)
              userFavorites = userFavorites.filter((id) => id !== fid);
            else userFavorites.push(fid);
            renderEvents();
            alert("Failed to update favorite: " + (data.error || resp.status));
          }
        } catch (err) {
          console.error("toggleFavorite error", err);
          // revert
          if (!isFavorited)
            userFavorites = userFavorites.filter((id) => id !== fid);
          else userFavorites.push(fid);
          renderEvents();
          alert("Network error while updating favorite");
        }
      };

      // View event details
      window.viewEventDetails = function (eventId) {
        window.location.href = `/web-proj/event.html?id=${eventId}`;
      };

      // Geolocation
      function getUserLocation() {
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(
            (position) => {
              userLocation = {
                lat: position.coords.latitude,
                lng: position.coords.longitude,
              };
              loadEvents();
            },
            (error) => {
              console.log("Location access denied:", error);
            }
          );
        }
      }

      // Search (renders filtered view, doesn't overwrite allEvents)
      function searchEvents() {
        const q1 = document.getElementById("search-input")?.value || "";
        const q2 = document.getElementById("header-search")?.value || "";
        const query = (q1 || q2).trim();

        if (!query) {
          renderEvents();
          return;
        }

        const filtered = allEvents.filter(
          (event) =>
            (event.name || event.title || "")
              .toLowerCase()
              .includes(query.toLowerCase()) ||
            (event.description || "")
              .toLowerCase()
              .includes(query.toLowerCase()) ||
            (event.location || "").toLowerCase().includes(query.toLowerCase())
        );

        const container = document.getElementById("events-container");
        if (filtered.length === 0) {
          container.innerHTML =
            '<div class="no-events"><h3>üòï No events found</h3><p>Try adjusting your search or filters</p></div>';
          return;
        }

        container.innerHTML = "";
        filtered.forEach((e) => container.appendChild(createEventCard(e)));
      }

      // Setup event listeners
      function setupEventListeners() {
        document
          .getElementById("search-btn")
          ?.addEventListener("click", searchEvents);
        document
          .getElementById("header-search-btn")
          ?.addEventListener("click", searchEvents);
        document
          .getElementById("search-input")
          ?.addEventListener("keypress", (e) => {
            if (e.key === "Enter") searchEvents();
          });
        document
          .getElementById("header-search")
          ?.addEventListener("keypress", (e) => {
            if (e.key === "Enter") searchEvents();
          });

        const toggleBtn = document.getElementById("filter-toggle");
        const panel = document.getElementById("filter-panel");
        if (toggleBtn && panel) {
          toggleBtn.addEventListener("click", () => {
            const open = panel.classList.contains("expanded");
            panel.classList.toggle("expanded", !open);
            panel.classList.toggle("collapsed", open);
            toggleBtn.innerText = open
              ? "Advanced Filters ‚ñæ"
              : "Advanced Filters ‚ñ¥";
            toggleBtn.setAttribute("aria-expanded", (!open).toString());
          });
        }

        document
          .getElementById("clear-filters-btn")
          ?.addEventListener("click", () => {
            const form = document.getElementById("filter-form");
            if (form) form.reset();
            selectedGenre = "";
            document
              .querySelectorAll(".genre-chip")
              .forEach((ch) =>
                ch.classList.toggle("active", ch.dataset.genre === "")
              );
            loadEvents();
          });

        const genreSelect = document.getElementById("genreFilter");
        if (genreSelect) {
          genreSelect.addEventListener("change", (e) => {
            selectedGenre = e.target.value;
            loadEvents();
          });
        }
      }
    </script>
  </body>
</html>
